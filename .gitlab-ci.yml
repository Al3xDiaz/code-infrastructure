image: docker:20.10.16
services:
  - docker:20.10.16-dind

stages:
  - init
  - validate
  - plan
  - apply

variables:
  GITLAB_AUTO_TFVARS: $GITLAB_AUTO_TFVARS
  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY

init:
  stage: init
  script:
    - terraform init \
      -backend-config=address=${TF_ADDRESS} \
      -backend-config=lock_address=${TF_ADDRESS}/lock \
      -backend-config=unlock_address=${TF_ADDRESS}/lock \
      -backend-config=username=${TF_USERNAME} \
      -backend-config=password=${TF_PASSWORD} \
      -backend-config=lock_method=POST \
      -backend-config=unlock_method=DELETE \
      -backend-config=retry_wait_min=5
    - echo "$GITLAB_AUTO_TFVARS" > terraform/gitlab.auto.tfvars
    - docker-compose run --rm  --entrypoint terraform terraform init -migrate-state -force-copy

validate:
  stage: validate
  script:
    - docker-compose run --rm  --entrypoint terraform terraform validate

plan:
  stage: plan
  script:
    - docker-compose run --rm  --entrypoint terraform terraform plan
  only:
    - main

apply:
  stage: apply
  script:
    - docker-compose run --rm  --entrypoint terraform terraform apply -auto-approve
  only:
    - main
  environment: production