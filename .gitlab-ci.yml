
image: hashicorp/terraform
services:
  - hashicorp/terraform:light

stages:
  - init-validate
  - apply
  - destroy

variables:
  SECURE_FILES_DOWNLOAD_PATH: 'terraform'
  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
before_script:
  - cd terraform/

init:
  stage: init-validate
  cache:
    key: build_cache
    paths:
     - terraform/.terraform
     - terraform/.terraform.lock.hcl
     - terraform/.terraform.tfstate
     - terraform/.terraform.tfstate.backup
     - terraform/gitlab.auto.tfvars
     - home/

  script:
    - terraform init
    - terraform validate

apply:
  stage: apply
  cache:
    key: build_cache
    paths:
     - terraform/.terraform
     - terraform/.terraform.lock.hcl
     - terraform/.terraform.tfstate
     - terraform/.terraform.tfstate.backup
     - terraform/gitlab.auto.tfvars
     - home/
  script:
    - terraform apply -auto-approve
  only:
    - main
  environment: production

destroy:
  stage: destroy
  cache:
    key: build_cache
    paths:
     - terraform/.terraform
     - terraform/.terraform.lock.hcl
     - terraform/.terraform.tfstate
     - terraform/.terraform.tfstate.backup
     - terraform/gitlab.auto.tfvars
     - home/
  when: manual
  script:
    - terraform destroy -auto-approve
  only:
    - main
  environment: production